### Using Alembic for Database Migrations

Alembic is a lightweight database migration tool used with SQLAlchemy to track changes in your database schema. It allows you to **create migrations** to reflect changes in your Python models and **apply those migrations** to your database.

## If Almebic Not Initiated, Go through this method

Let’s go through the **process of setting up Alembic**, generating migration scripts for the `User` model, and applying those migrations.

1. **Setting Up Alembic**

A.**Install Alembic**

If you haven’t installed Alembic yet, you can install it via pip:

```bash
pip install alembic

```

B.**Initialize Alembic in Your Project**

To initialize Alembic in your project, navigate to your project directory and run:

```bash
alembic init alembic

```

This will create a new directory named `alembic` with the following structure:

```
alembic/
    versions/       # This folder will store the migration scripts
    env.py          # Configuration to link your models with Alembic
alembic.ini         # Alembic configuration file

```

2. **Configuring Alembic to Work with SQLAlchemy Models**

Now, we need to configure Alembic so it can detect changes in your SQLAlchemy models (like the `User` model) and generate migration scripts.

A.**Modify `alembic/env.py`**

Open the `alembic/env.py` file and make sure it imports your `Base` (which contains the `User` model) and sets it as the `target_metadata`. This allows Alembic to track changes in your models.

Modify the `env.py` file as follows:

```python
from app.database.db import Base  # Import your Base
from alembic import context
from sqlalchemy import engine_from_config, pool

config = context.config
target_metadata = Base.metadata  # Set target metadata to your models' metadata

def run_migrations_online():
    connectable = engine_from_config(
        config.get_section(config.config_ini_section),
        prefix='sqlalchemy.',
        poolclass=pool.NullPool,
    )

    with connectable.connect() as connection:
        context.configure(connection=connection, target_metadata=target_metadata)

        with context.begin_transaction():
            context.run_migrations()

```

- **`Base.metadata`**: This ensures Alembic tracks your models and can generate migration scripts based on them.

B. **Set the Database URL in `alembic.ini`**

In the `alembic.ini` file, set the `sqlalchemy.url` to your database URL (e.g., SQLite, PostgreSQL, etc.).

For example, if you're using SQLite:

```
sqlalchemy.url = sqlite:///./DirectDrop.db

```

Make sure the path points to your actual database file.

3. **Generating a Migration Script**

Now that Alembic is set up, you can generate a migration script based on your SQLAlchemy models (like the `User` model).

ZA. **Create the Migration Script**

To generate a migration script, run the following command:

```bash
alembic revision --autogenerate -m "create users table"

```

This command:

- **`revision`**: Creates a new revision (or migration).
- **`-autogenerate`**: Automatically generates the migration script by comparing the current database schema to the models.
- **`m`**: Specifies the message describing the migration (in this case, creating the `users` table).

This will generate a migration file inside the `alembic/versions` folder, which contains the SQL changes needed to reflect your `User` model in the database.

B. **Migration Script Example**

The autogenerated migration file (e.g., `alembic/versions/123456_create_users_table.py`) might look like this:

```python
"""create users table

Revision ID: 1234567890ab
Revises:
Create Date: 2023-09-12

"""
from alembic import op
import sqlalchemy as sa

# revision identifiers, used by Alembic.
revision = '1234567890ab'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    # Code to create the users table
    op.create_table(
        'users',
        sa.Column('id', sa.Integer(), nullable=False),
        sa.Column('first_name', sa.String(), nullable=False),
        sa.Column('last_name', sa.String(), nullable=False),
        sa.Column('password', sa.Integer(), nullable=False),
        sa.Column('email', sa.String(), nullable=False),
        sa.Column('created_at', sa.TIMESTAMP(timezone=True), server_default=sa.text('CURRENT_TIMESTAMP'), nullable=False),
        sa.Column('is_verified', sa.Boolean(), server_default='FALSE', nullable=False),
        sa.Column('is_admin', sa.Boolean(), server_default='FALSE', nullable=False),
        sa.PrimaryKeyConstraint('id'),
        sa.UniqueConstraint('email'),
        sa.UniqueConstraint('first_name'),
        sa.UniqueConstraint('last_name')
    )

def downgrade():
    # Code to drop the users table if we need to rollback the migration
    op.drop_table('users')

```

- **`upgrade()`**: This function contains the logic to apply the migration (e.g., creating the `users` table).
- **`downgrade()`**: This function reverses the migration (e.g., dropping the `users` table) in case you need to roll back.

4. **Applying the Migration**

After generating the migration script, you can apply the migration to your database.

A. **Run the Migration**

To apply the migration, run the following command:

```bash
alembic upgrade head

```

- **`upgrade head`**: Applies all the new migrations and updates your database schema to the latest state.

This will create the `users` table in your database, reflecting the structure of the `User` model.

5. **Checking the Database**

Once the migration has been applied, you can check your database to ensure that the `users` table has been created with the correct columns.

For SQLite, you can use a tool like **DB Browser for SQLite** to inspect the database, or run a query like this:

```sql
SELECT * FROM users;

```

6. **Rolling Back a Migration**

If you need to undo the migration (for example, if something went wrong), you can use the `downgrade` command:

```bash
alembic downgrade -1

```

This will undo the last applied migration (i.e., drop the `users` table in this case).
